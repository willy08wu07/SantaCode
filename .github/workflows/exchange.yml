name: Gift Exchange (Admin Only)

on:
  workflow_dispatch:
    inputs:
      confirm_exchange:
        description: 'Type "MERRY CHRISTMAS" to confirm exchange'
        required: true

jobs:
  exchange:
    runs-on: ubuntu-latest
    if: github.event.inputs.confirm_exchange == 'MERRY CHRISTMAS'
    timeout-minutes: 60  # Ensure enough time for 100+ sequential executions
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.13'

      - name: Pre-pull Docker Images
        run: |
          echo "Pre-warming Docker cache..."
          # Pulling largest images first
          docker pull swift:5.8-slim &
          docker pull rust:slim &
          docker pull gcc:12 &
          docker pull eclipse-temurin:17-jdk &
          docker pull mcr.microsoft.com/dotnet/sdk:8.0 &
          docker pull zenika/kotlin:latest &
          docker pull python:3.13-slim &
          docker pull node:18-alpine &
          docker pull alpine:3.18 &
          docker pull golang:1.23-alpine &
          docker pull ruby:3.3-alpine &
          wait
          echo "All images prepared!"

      - name: Run Exchange Logic
        run: |
          echo "Starting the Great SantaCode Exchange..."
          python3 core/exchange.py
          
      - name: Upload Match Report
        uses: actions/upload-artifact@v4
        with:
          name: secret-santa-matches-report
          path: match_report.csv

      - name: Create Announcement Issue (Multi-language)
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            // Read participants from match report
            const reportPath = 'match_report.csv';
            let participantCount = 0;

            try {
              const report = fs.readFileSync(reportPath, 'utf8');
              participantCount = report.split('\n').length - 2; // Exclude header and empty line
            } catch (error) {
              participantCount = 'N/A';
            }

            // Get workflow run URL
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            const year = new Date().getFullYear();
            const exchangeDate = new Date().toISOString().split('T')[0];
            const bold = '**';
            const codeBlock = '```';

            // Build multi-language issue body with collapsible sections
            const issueBody = [
              '# ğŸ„ SantaCode Exchange Completed! | äº¤æ›å®Œæˆï¼ | äº¤æ›å®Œäº†ï¼ğŸ',
              '',
              '> ğŸŒ Choose your language below | åœ¨ä¸‹æ–¹é¸æ“‡ä½ çš„èªè¨€ | ä»¥ä¸‹ã‹ã‚‰è¨€èªã‚’é¸æŠã—ã¦ãã ã•ã„',
              '',
              '---',
              '',
              '<details open>',
              '<summary><h2>ğŸ‡¬ğŸ‡§ English Version</h2></summary>',
              '',
              '## Exchange Results',
              '',
              `The ${bold}${year} SantaCode Gift Exchange${bold} has been successfully completed!`,
              '',
              '### ğŸ“Š Statistics',
              `- ${bold}Participants${bold}: ${participantCount}`,
              `- ${bold}Exchange Date${bold}: ${exchangeDate}`,
              `- ${bold}Status${bold}: âœ… Completed`,
              '',
              '### ğŸ How to Find Your Match',
              '',
              'Your secret santa match has been delivered to your submission folder:',
              '',
              `${codeBlock}bash`,
              '# Check your folder',
              'ls -la submissions/<your-github-username>/',
              '',
              '# You should see a new file from your secret santa!',
              codeBlock,
              '',
              '### ğŸ“¥ Download Full Report',
              '',
              'The complete matching report is available as an artifact in the workflow run:',
              `- [Download Match Report](${runUrl})`,
              '',
              "### ğŸ… What's Next?",
              '',
              `1. ${bold}Check your folder${bold} for the gift you received`,
              `2. ${bold}Run the code${bold} to see what your secret santa created for you`,
              `3. ${bold}Share your experience${bold} in the Discussions tab`,
              `4. ${bold}Star the repo${bold} if you enjoyed participating!`,
              '',
              '### ğŸ“¢ How This Notification Works',
              '',
              'This issue was automatically created by GitHub Actions. All participants who are watching this repository will receive a notification. No spam, no manual @mentions!',
              '',
              `ğŸŒŸ ${bold}Thank you for participating in SantaCode ${year}!${bold} ğŸŒŸ`,
              '',
              '</details>',
              '',
              '---',
              '',
              '<details>',
              '<summary><h2>ğŸ‡¹ğŸ‡¼ ç¹é«”ä¸­æ–‡ç‰ˆæœ¬</h2></summary>',
              '',
              '## äº¤æ›çµæœ',
              '',
              `${bold}${year} SantaCode ç¦®ç‰©äº¤æ›${bold}å·²æˆåŠŸå®Œæˆï¼`,
              '',
              '### ğŸ“Š çµ±è¨ˆè³‡æ–™',
              `- ${bold}åƒèˆ‡äººæ•¸${bold}: ${participantCount}`,
              `- ${bold}äº¤æ›æ—¥æœŸ${bold}: ${exchangeDate}`,
              `- ${bold}ç‹€æ…‹${bold}: âœ… å·²å®Œæˆ`,
              '',
              '### ğŸ å¦‚ä½•æ‰¾åˆ°ä½ çš„é…å°',
              '',
              'ä½ çš„ç¥ç§˜è–èª•è€äººé…å°å·²é€é”ä½ çš„æäº¤è³‡æ–™å¤¾ï¼š',
              '',
              `${codeBlock}bash`,
              '# æª¢æŸ¥ä½ çš„è³‡æ–™å¤¾',
              'ls -la submissions/<ä½ çš„-github-ç”¨æˆ¶å>/',
              '',
              '# ä½ æ‡‰è©²æœƒçœ‹åˆ°ä¾†è‡ªç¥ç§˜è–èª•è€äººçš„æ–°æª”æ¡ˆï¼',
              codeBlock,
              '',
              '### ğŸ“¥ ä¸‹è¼‰å®Œæ•´å ±å‘Š',
              '',
              'å®Œæ•´çš„é…å°å ±å‘Šå¯åœ¨å·¥ä½œæµç¨‹åŸ·è¡Œä¸­ä½œç‚º artifact ä¸‹è¼‰ï¼š',
              `- [ä¸‹è¼‰é…å°å ±å‘Š](${runUrl})`,
              '',
              '### ğŸ… æ¥ä¸‹ä¾†åšä»€éº¼ï¼Ÿ',
              '',
              `1. ${bold}æª¢æŸ¥ä½ çš„è³‡æ–™å¤¾${bold}ï¼ŒæŸ¥çœ‹æ”¶åˆ°çš„ç¦®ç‰©`,
              `2. ${bold}åŸ·è¡Œç¨‹å¼ç¢¼${bold}ï¼Œçœ‹çœ‹ä½ çš„ç¥ç§˜è–èª•è€äººå‰µä½œäº†ä»€éº¼`,
              `3. ${bold}åˆ†äº«ä½ çš„é«”é©—${bold}ï¼Œåœ¨ Discussions åˆ†é ä¸­`,
              `4. ${bold}çµ¦å°ˆæ¡ˆæŒ‰æ˜Ÿæ˜Ÿ${bold}ï¼Œå¦‚æœä½ å–œæ­¡é€™æ¬¡æ´»å‹•ï¼`,
              '',
              '### ğŸ“¢ é€šçŸ¥æ©Ÿåˆ¶èªªæ˜',
              '',
              'æ­¤ Issue ç”± GitHub Actions è‡ªå‹•å»ºç«‹ã€‚æ‰€æœ‰ Watch æ­¤ repository çš„åƒèˆ‡è€…éƒ½æœƒæ”¶åˆ°é€šçŸ¥ã€‚ç„¡åƒåœ¾è¨Šæ¯ï¼Œç„¡æ‰‹å‹• @mentionsï¼',
              '',
              `ğŸŒŸ ${bold}æ„Ÿè¬åƒèˆ‡ SantaCode ${year}ï¼${bold} ğŸŒŸ`,
              '',
              '</details>',
              '',
              '---',
              '',
              '<details>',
              '<summary><h2>ğŸ‡¯ğŸ‡µ æ—¥æœ¬èªç‰ˆ</h2></summary>',
              '',
              '## äº¤æ›çµæœ',
              '',
              `${bold}${year} SantaCode ãƒ—ãƒ¬ã‚¼ãƒ³ãƒˆäº¤æ›${bold}ãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸï¼`,
              '',
              '### ğŸ“Š çµ±è¨ˆ',
              `- ${bold}å‚åŠ è€…æ•°${bold}: ${participantCount}`,
              `- ${bold}äº¤æ›æ—¥${bold}: ${exchangeDate}`,
              `- ${bold}ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹${bold}: âœ… å®Œäº†`,
              '',
              '### ğŸ ãƒãƒƒãƒãƒ³ã‚°ã®ç¢ºèªæ–¹æ³•',
              '',
              'ã‚ãªãŸã®ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚µãƒ³ã‚¿ã®ãƒãƒƒãƒãƒ³ã‚°ãŒã‚ãªãŸã®æå‡ºãƒ•ã‚©ãƒ«ãƒ€ã«é…ä¿¡ã•ã‚Œã¾ã—ãŸï¼š',
              '',
              `${codeBlock}bash`,
              '# ãƒ•ã‚©ãƒ«ãƒ€ã‚’ãƒã‚§ãƒƒã‚¯',
              'ls -la submissions/<your-github-username>/',
              '',
              '# è¬ã®ã‚µãƒ³ã‚¿ã‹ã‚‰ã®æ–°ã—ã„ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ï¼',
              codeBlock,
              '',
              '### ğŸ“¥ å®Œå…¨ãªãƒ¬ãƒãƒ¼ãƒˆã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰',
              '',
              'å®Œå…¨ãªãƒãƒƒãƒãƒ³ã‚°ãƒ¬ãƒãƒ¼ãƒˆã¯ã€ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œã®æˆæœç‰©ã¨ã—ã¦åˆ©ç”¨ã§ãã¾ã™ï¼š',
              `- [ãƒãƒƒãƒãƒ³ã‚°ãƒ¬ãƒãƒ¼ãƒˆã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰](${runUrl})`,
              '',
              '### ğŸ… æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—',
              '',
              `1. ${bold}ãƒ•ã‚©ãƒ«ãƒ€ã‚’ãƒã‚§ãƒƒã‚¯${bold}ã—ã¦ã€å—ã‘å–ã£ãŸãƒ—ãƒ¬ã‚¼ãƒ³ãƒˆã‚’ç¢ºèª`,
              `2. ${bold}ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œ${bold}ã—ã¦ã€ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚µãƒ³ã‚¿ãŒä½œæˆã—ãŸã‚‚ã®ã‚’è¦‹ã‚‹`,
              `3. ${bold}ä½“é¨“ã‚’å…±æœ‰${bold}ã€Discussions ã‚¿ãƒ–ã§`,
              `4. ${bold}ãƒªãƒã‚¸ãƒˆãƒªã«ã‚¹ã‚¿ãƒ¼${bold}ã‚’ä»˜ã‘ã¦ã€å‚åŠ ã‚’æ¥½ã—ã‚“ã å ´åˆï¼`,
              '',
              '### ğŸ“¢ é€šçŸ¥ã®ä»•çµ„ã¿',
              '',
              'ã“ã® Issue ã¯ GitHub Actions ã«ã‚ˆã£ã¦è‡ªå‹•çš„ã«ä½œæˆã•ã‚Œã¾ã—ãŸã€‚ã“ã®ãƒªãƒã‚¸ãƒˆãƒªã‚’ Watch ã—ã¦ã„ã‚‹ã™ã¹ã¦ã®å‚åŠ è€…ã«é€šçŸ¥ãŒå±Šãã¾ã™ã€‚ã‚¹ãƒ‘ãƒ ãªã—ã€æ‰‹å‹• @mentions ãªã—ï¼',
              '',
              `ğŸŒŸ ${bold}SantaCode ${year} ã«ã”å‚åŠ ã„ãŸã ãã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼${bold} ğŸŒŸ`,
              '',
              '</details>',
              '',
              '---',
              '',
              `${bold}Automated by GitHub Actions${bold} - [View Workflow Run](${runUrl})`
            ].join('\n');

            // Create single multi-language issue
            console.log('Creating multi-language announcement issue...');
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ğŸ„ SantaCode Exchange Completed! | äº¤æ›å®Œæˆï¼ | äº¤æ›å®Œäº†ï¼ğŸ',
              body: issueBody,
              labels: ['announcement', 'exchange-completed']
            });

            console.log(`âœ… Multi-language announcement created: Issue #${issue.data.number}`);
